<script>
(function () {

  const tg = window.Telegram?.WebApp;
  const WORKER_URL = "https://asiagold-api.qalandar65.workers.dev";
  const app = document.getElementById("app");

  if (!tg || !tg.initData) {
    app.innerHTML = "<p class='text'>âŒ ÙÙ‚Ø· Ø¯Ø§Ø®Ù„ ØªÙ„Ú¯Ø±Ø§Ù… Ù‚Ø§Ø¨Ù„ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø³Øª</p>";
    return;
  }

  tg.ready();
  tg.expand();

  let USER = {
    first: "",
    last: "",
    phone: ""
  };

  async function start() {
    app.innerHTML = "<p class='text'>Ø¯Ø± Ø­Ø§Ù„ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØªâ€¦</p>";

    const res = await fetch(WORKER_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ initData: tg.initData })
    });

    const json = await res.json();
    if (!json.ok) {
      app.innerHTML = "<p class='text'>Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„</p>";
      return;
    }

    renderRegister();
  }

  function renderRegister() {
    app.innerHTML = `
      <h1>Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</h1>
      <input id="first" placeholder="Ù†Ø§Ù…" />
      <input id="last" placeholder="Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ" />
      <button id="next">Ø§Ø¯Ø§Ù…Ù‡</button>
    `;

    document.getElementById("next").onclick = () => {
      const f = document.getElementById("first").value.trim();
      const l = document.getElementById("last").value.trim();
      if (!f || !l) {
        alert("Ù†Ø§Ù… Ùˆ Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯");
        return;
      }
      USER.first = f;
      USER.last = l;
      renderTerms();
    };
  }

  function renderTerms() {
    app.innerHTML = `
      <h1>Ù‚ÙˆØ§Ù†ÛŒÙ† Ùˆ Ù…Ù‚Ø±Ø±Ø§Øª</h1>
      <div class="text">
        â€¢ Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´ ÙÙ‚Ø· Ù¾Ø³ Ø§Ø² ØªØ£ÛŒÛŒØ¯ Ù…Ø¯ÛŒØ± ÙØ±ÙˆØ´ Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª.<br>
        â€¢ Ù…Ø³Ø¦ÙˆÙ„ÛŒØª ØµØ­Øª Ø³ÙØ§Ø±Ø´ Ø¨Ø± Ø¹Ù‡Ø¯Ù‡ Ø«Ø¨Øªâ€ŒÚ©Ù†Ù†Ø¯Ù‡ Ø§Ø³Øª.<br>
        â€¢ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ù…Ø§ Ù…Ø­Ø±Ù…Ø§Ù†Ù‡ Ø¨Ø§Ù‚ÛŒ Ù…ÛŒâ€ŒÙ…Ø§Ù†Ø¯.<br>
      </div>
      <div class="checkbox">
        <input type="checkbox" id="accept" />
        <label for="accept">Ù‚ÙˆØ§Ù†ÛŒÙ† Ø±Ø§ Ù…Ø·Ø§Ù„Ø¹Ù‡ Ú©Ø±Ø¯Ù… Ùˆ Ù…ÛŒâ€ŒÙ¾Ø°ÛŒØ±Ù…</label>
      </div>
      <button id="confirm">ØªØ£ÛŒÛŒØ¯ Ùˆ Ø§Ø¯Ø§Ù…Ù‡</button>
    `;

    document.getElementById("confirm").onclick = () => {
      if (!document.getElementById("accept").checked) {
        alert("Ø¨Ø§ÛŒØ¯ Ù‚ÙˆØ§Ù†ÛŒÙ† Ø±Ø§ Ø¨Ù¾Ø°ÛŒØ±ÛŒØ¯");
        return;
      }
      requestPhone();
    };
  }

  function requestPhone() {
    app.innerHTML = `
      <h1>ØªØ£ÛŒÛŒØ¯ Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„</h1>
      <p class="text">Ø¨Ø±Ø§ÛŒ Ø§Ø¯Ø§Ù…Ù‡ØŒ Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ø®ÙˆØ¯ Ø±Ø§ ØªØ£ÛŒÛŒØ¯ Ú©Ù†ÛŒØ¯</p>
      <button id="phone">ğŸ“± ØªØ£ÛŒÛŒØ¯ Ø´Ù…Ø§Ø±Ù‡</button>
    `;

    document.getElementById("phone").onclick = () => {
      tg.requestContact((ok, data) => {
        if (!ok) {
          alert("Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø´Ù…Ø§Ø±Ù‡ ØªÙ„ÙÙ† Ø±Ø¯ Ø´Ø¯");
          return;
        }

        USER.phone = data.phone_number;
        submitRegister();
      });
    };
  }

  async function submitRegister() {
    app.innerHTML = "<p class='text'>Ø¯Ø± Ø­Ø§Ù„ Ø«Ø¨Øª Ø§Ø·Ù„Ø§Ø¹Ø§Øªâ€¦</p>";

    const res = await fetch(WORKER_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        initData: tg.initData,
        profile: USER
      })
    });

    const json = await res.json();
    if (!json.ok) {
      app.innerHTML = "<p class='text'>Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ø§Ø·Ù„Ø§Ø¹Ø§Øª</p>";
      return;
    }

    localStorage.setItem("token", json.token);
    renderPending();
  }

  function renderPending() {
    app.innerHTML = `
      <h1>Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯</h1>
      <p class="text">
        Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ù…Ø§ Ø«Ø¨Øª Ø´Ø¯ âœ…<br>
        Ù¾Ø³ Ø§Ø² ØªØ£ÛŒÛŒØ¯ Ù…Ø¯ÛŒØ± ÙØ±ÙˆØ´ØŒ Ø§Ù…Ú©Ø§Ù† Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´ ÙØ¹Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯.
      </p>
    `;
  }

  start();

})();
</script>
