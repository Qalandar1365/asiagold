<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>سفارش</title>

  <!-- Telegram WebApp -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    * {
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    }

    :root {
      --bg: var(--tg-theme-bg-color, #ffffff);
      --text: var(--tg-theme-text-color, #1f1f1f);
      --hint: var(--tg-theme-hint-color, #6b7280);
      --card: var(--tg-theme-secondary-bg-color, #ffffff);
      --border: rgba(0, 0, 0, 0.08);
      --radius: 12px;
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--text);
    }

    .container {
      padding: calc(16px + env(safe-area-inset-top)) calc(16px + env(safe-area-inset-right)) calc(24px + env(safe-area-inset-bottom)) calc(16px + env(safe-area-inset-left));
      max-width: 420px;
      margin: 0 auto;
    }

    .title {
      margin: 0 0 12px;
      font-size: 18px;
      font-weight: 700;
    }

    .card {
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--card);
      padding: 12px;
    }

    .row {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 10px;
      padding: 8px 0;
      border-bottom: 1px solid var(--border);
    }

    .row:last-child {
      border-bottom: 0;
      padding-bottom: 0;
    }

    .label {
      color: var(--hint);
      font-size: 12px;
      white-space: nowrap;
    }

    .value {
      font-size: 14px;
      font-weight: 700;
      text-align: left;
      direction: rtl;
    }

    .message {
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px dashed var(--border);
      background: rgba(0, 0, 0, 0.02);
      color: var(--hint);
      font-size: 13px;
      line-height: 1.6;
    }
  </style>
</head>

<body>
  <main class="container" aria-label="سفارش">
    <h1 class="title">سفارش</h1>

    <section class="card" aria-label="اطلاعات انتخاب">
      <div class="row">
        <div class="label">گروه</div>
        <div class="value" id="parent-name">—</div>
      </div>
      <div class="row">
        <div class="label">زیرگروه</div>
        <div class="value" id="child-name">—</div>
      </div>
    </section>

    <div class="message" id="message" role="status"></div>
    <label id="order-qty-label" for="order-qty" hidden>تعداد</label>
    <input id="order-qty" type="number" min="1" hidden />
    <label id="order-weight-label" for="order-weight" hidden>وزن (گرم)</label>
    <input id="order-weight" type="number" min="0" step="0.01" hidden />
    <button id="submit-order" type="button" disabled hidden>ثبت سفارش</button>
  </main>

  <script>
    (function () {
      const tg = window.Telegram?.WebApp;
      tg?.ready?.();
      tg?.expand?.();

      const PARENTS = {
        bangle: "النگو",
        khorderiz: "خرده‌ریز",
        bar: "شمش",
        custom: "محصول تک‌ساز"
      };

      const CHILDREN = {
        bangle: {
          simple: "ساده",
          patterned: "طرح‌دار",
          sizing: "سایزبندی"
        }
      };

      const parentNameEl = document.getElementById("parent-name");
      const childNameEl = document.getElementById("child-name");
      const messageEl = document.getElementById("message");
      const qtyLabelEl = document.getElementById("order-qty-label");
      const qtyInput = document.getElementById("order-qty");
      const weightLabelEl = document.getElementById("order-weight-label");
      const weightInput = document.getElementById("order-weight");
      const submitBtn = document.getElementById("submit-order");

      function parseHashParams() {
        const raw = (location.hash || "").startsWith("#") ? location.hash.slice(1) : (location.hash || "");
        const params = new URLSearchParams(raw);
        return {
          parent: (params.get("parent") || "").trim(),
          child: (params.get("child") || "").trim()
        };
      }

      function render() {
        const { parent, child } = parseHashParams();
        let messageText = "";

        const isBangle = parent === "bangle";
        qtyLabelEl.hidden = !isBangle;
        qtyInput.hidden = !isBangle;
        weightLabelEl.hidden = !isBangle;
        weightInput.hidden = !isBangle;
        submitBtn.hidden = !isBangle;

        if (!parent || !(parent in PARENTS)) {
          parentNameEl.textContent = "—";
          childNameEl.textContent = "—";
          messageText = "پارامتر «parent» در لینک وجود ندارد یا نامعتبر است. لطفاً از داشبورد وارد شوید.";
        } else {
          parentNameEl.textContent = PARENTS[parent];

          if (isBangle) {
            const childLabel = CHILDREN.bangle[child];
            childNameEl.textContent = childLabel || child || "—";
            submitBtn.disabled = !updateSubmitState();
          } else {
            childNameEl.textContent = child || "—";
            messageText = "این گروه در مرحله بعد پیاده‌سازی می‌شود";
          }
        }

        messageEl.textContent = messageText;
        messageEl.style.display = messageText ? "" : "none";
      }

      function updateSubmitState() {
        const qty = Number(qtyInput.value);
        const weight = Number(weightInput.value);
        const isValid = qty > 0 && weight > 0;
        submitBtn.disabled = !isValid;
        return isValid;
      }

      qtyInput.addEventListener("input", updateSubmitState);
      weightInput.addEventListener("input", updateSubmitState);

      submitBtn.addEventListener("click", () => {
        if (!updateSubmitState()) return;
        const qty = Number(qtyInput.value);
        const weight = Number(weightInput.value);

        let cart = null;
        const cartRaw = sessionStorage.getItem("cart");
        if (cartRaw) {
          try {
            cart = JSON.parse(cartRaw);
          } catch (_) {
            cart = null;
          }
        }
        if (!cart || !Array.isArray(cart.items)) {
          cart = { items: [], status: "draft" };
        } else {
          cart.status = "draft";
        }

        let bangleItem = null;
        const nextItems = [];
        for (const item of cart.items) {
          if (item && item.type === "bangle") {
            if (!bangleItem) {
              bangleItem = item;
              nextItems.push(item);
            }
            continue;
          }
          nextItems.push(item);
        }
        cart.items = nextItems;

        if (bangleItem) {
          const prevQty = Number(bangleItem.qty);
          const prevWeight = Number(bangleItem.weight);
          bangleItem.qty = (Number.isFinite(prevQty) ? prevQty : 0) + qty;
          bangleItem.weight = (Number.isFinite(prevWeight) ? prevWeight : 0) + weight;
        } else {
          cart.items.push({ type: "bangle", qty, weight });
        }

        sessionStorage.setItem("cart", JSON.stringify(cart));
        window.location.href = "user-dashboard.html?from=order";
      });

      render();
      window.addEventListener("hashchange", render);
    })();
  </script>
</body>
</html>
